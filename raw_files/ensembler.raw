
<!--REMARK PHENIX TITLE START  Put your title here>


<H4><U>Ensemble creation with Ensembler</U></H4> 


<!--REMARK PHENIX TITLE END-->

<!--REMARK PHENIX BODY START   Put your text here. 
Anything enclosed in header html H4 H5 etc will go in the table of contents>


<P><H5><U><B>Author(s)</B></U></H5></P>
<UL>
<LI>ensembler: Gabor Bunkoczi</LI>
<LI>PHENIX GUI: Nathaniel Echols</LI>
</UL>

<P><H5><U>Purpose</U></H5></P>

<P>
Ensembler can be used to superpose multiple chains to be used as an ensemble
search model for molecular replacement.
</P>

<P><H5><U>Usage</U></H5></P>
<P>
Ensembler can be run from the PHENIX GUI and the command line, the only
difference being the way commands are taken from the user.
</P>

<P><H5>Input files</H5></P>
<UL>
<LI><B>Structures</B> <I>(compulsory)</I>. The chains that are to be
superposed. Protein chains are automatically identified, other chains are
discarded. In case the structure contains multiple chains, these will all be
used for superposition. Accepted formats: PDB. Recognized extensions:
<TT>.pdb</TT>, <TT>.ent</TT>.</LI>
<LI><B>Alignment</B> <I>(optional)</I>. In case a user-supplied residue mapping
is desired, this can be achieved by selecting the appropriate mode and
supplying alignment files. Accepted extensions (with the corresponding format)
are <TT>.aln</TT> (CLUSTAL format), <TT>.pir</TT> (PIR-format) and <TT>.ali</TT>
(relaxed PIR-like format).</LI>
</UL>

<P><H5>Command line</H5></P>
<PRE><TT><B>phenix.ensembler</B> \
    [ command-line switches ] \
    [ PHIL-format parameter files ] \
    [ PHIL command-line assignments ] \
    [ PDB-files ] \
    [ alignment files ]</TT></PRE>

<P><H6>Command-line switches:</H6></P>
<PRE><TT>
  <B>-h, --help</B>            show this help message and exit
  <B>--show-defaults</B>       print PHIL and exit
  <B>-i, --stdin</B>           read PHIL from stdin as well
  <B>-v, --verbosity</B>       set verbosity level (DEBUG,INFO,WARNING,VERBOSE)
</TT></PRE>

<P><H6>PHIL arguments:</H6></P>
<P>
Everything not starting with a dash('-') is interpreted as a PHIL argument.
This can be a PHIL-format file containing parameters, command-line assignment
or a file whose type is automatically recognized (based on file extension;
structure files and alignment files are recognized automatically).
</P>

<P><H5>GUI</H5></P>
<P>
The graphical user interface makes all settings accessible either as part of
the main window (for frequently used options) or as a dialog box <B>Ensemble
generation settings...</B>. Input files are specified either by the
<B>+</B>/<B>-</B> button pair, or by drag-and-drop onto the window area. File
types are automatically recognized, and added to the relevant input section.
</P>

<P><H5>Output files</H5></P>
<P>
The superposed chains can be written out either as a quasi multiple model PDB
file that is readable by phaser directly (output style <TT><B>merged</B></TT>,
output file name <TT><B>root_merged.pdb</B></TT>) or as a series of files
containing each chain separately (output syle <TT><B>separate</B></TT>, file
name <TT><B>root_pdb_chain.pdb</B></TT>, where pdb is the name of the PDB file
the chain was read from, and chain is the chain identifier). The file name
<TT><B>root</B></TT> can be changed via the <TT><B>root</B></TT> parameter of
the <TT><B>output</B></TT> (default: <TT>ensemble</TT>).
</P>

<P><H5><U>Description</U></H5></P>
<P>
The workflow consists of several stages that can be independently configured.
These are listed in order of execution. For a summary of all keywords with the
corresponding defaults, see the <B>Additional information</B> section.
</P>

<P><H5>Residue mapping</H5></P>
<P>
Establishes the equivalence of residues among the input chains. There are
several options available:
<UL>
<LI><TT><B>ssm</B></TT> - Do structure-based SSM alignment (default).</LI>
<LI><TT><B>muscle</B></TT> - Generate a sequence alignment with MUSCLE and use
that to align the residues.</LI>
<LI><TT><B>multiple_alignment</B></TT> - A user supplied multiple alignment is
used. An error message will be raised if this is not present or does not cover
all present chains.</LI>
<LI><TT><B>alignments</B></TT> - A series of alignments is used that <B>all
have the same first sequence</B> (i.e. a series of pairwise alignments against
the same target sequence). An error message will be raised if these do not cover
all present chains.</LI>
<LI><TT><B>resid</B></TT> - Residue sequence number with insertion code will be
used.</LI>
</UL>
Most common residue mapping mode is <TT><B>ssm</B></TT>. If no SSM alignment can
be done or this is imprecise (e.g. no secondary structure),
<TT><B>muscle</B></TT> is a good second choice.
</P>

<P><H5>Atom mapping</H5></P>
<P>
Maps selected atoms within equivalent residues to each other. The mapping is
done by name hence the order of atoms in the residue does not matter. If atoms
are missing from certain residues (or if certain residues contain extra atoms),
a gap will be filled where necessary. Atom selection is controlled by the
<TT><B>atoms</B></TT> parameter of the <TT><B>configuration</B></TT> scope.
Default atom selection: CA.
</P>

<P><H5>Superposition</H5></P>
<P>
Equivalent positions are superposed iteratively to find a globally optimal
solution. There are two superposition algorithms implemented, which
primarily differ in how they handle gaps in equivalent positions.
</P>
<UL>
<LI><TT><B>gapless</B></TT>. This algorithm discards all positions where gaps
are present, For further details, see Diamond (1992).</LI>
<LI><TT><B>gapped</B></TT>. This algorithm can use all positions as long as
there are two sites presents (i.e. not gaps), and may give better results for
chains with distant sequence identity. For the exact algorithm, see
Wang & Snoeyink (2008).</LI>
</UL>
<P>
Both algorithms use Diamond's formulation to solve the pairwise rotational
superposition problem (Diamond, 1988).
</P>
<P>
An exception is raised if there are less than 3 sites present for superposition.</P>
<P>
Multiple superposition is an iterative process and consists of a series of
pairwise superpositions. The convergence criterion is controlled by the
<TT><B>convergence</B></TT> parameter (in the <TT><B>superposition</B></TT>
scope), which is the r.m.s. difference change between two consecutive
iterations.
</P>

<P><H5>Weighting</H5></P>
<P>
Automatic weighting can be used to improve superposition, either to amplify
highly homologous regions or to decrease the effect of incorrect
site-equivalence (typically arises because of a wrong alignment). Implemented
weighting schemes are as follows:
</P>
<UL>
<LI><TT><B>unit</B></TT> - Unit weights (equivalent to no weighting).</LI>
<LI><TT><B>robust_resistant</B></TT> - Robust-resistant weighting scheme
(default). This tends to converge fast and give reliable results. The exact
formula for weighting is as follows:
<CENTER><TT>
w = 1 - ( delta<SUP>2</SUP> / tolerance<SUP>2</SUP> )<SUP>2</SUP>
 if delta < tolerance<BR>
w = 0 (otherwise)
</TT></CENTER>
where <TT>delta</TT> is the deviation from the average. Tolerance is an
empirical value, and its optimal value is close to ( unweighted r.m.s.d. )
<SUP>2</SUP> and can be controlled by the <TT><B>critical</B></TT> parameter of
the <TT><B>robust_resistant</B></TT> scope.</LI>
</UL>
<P>
Weighting is iterated with superposition until weights converge, which can be
controlled by the <TT><B>convergence</B></TT> parameter of the
<TT><B>weighting</B></TT> scope.
</P>
<P>
In case of highly dissimilar structures (or incorrect residue mapping), weight
determination may temporarily need to be damped to avoid divergence. This is
done automatically (in steps controlled by the
<TT><B>incremental_damping_factor</B></TT> parameter of the
<TT><B>weighting</B></TT> scope), until a preset value (controlled by the
<TT><B>max_damping_factor</B></TT> parameter of the <TT><B>weighting</B></TT>
scope) is reached, at which point an exception is raised.
</P>

<P><H5>Cluster analysis</H5></P>
<P>
Hierarchical cluster analysis is performed using the pairwise r.m.s.
differences as a distance measure. The <TT><B>clustering</B></TT> parameter of
the <TT><B>configuration</B></TT> score can be used to adjust cluster
boundaries.
</P>

<P><H5>Chain trimming</H5></P>
<P>
This option trims residues from the final superposed model where the unweighted
r.m.s.d. is above a certain threshold (<TT><B>threshold</B></TT> parameter of
the <TT><B>trimming</B></TT> scope). Useful in removing flexible loops, etc.
Default: no trimming.
</P>

<P><H5>Sorting</H5></P>
<P>
After superposition is complete, the chains can be sorted by sequence identity
(<TT><B>identity</B></TT>), fraction of common sites wrt all aligned atom
positions (<TT><B>overlap</B></TT>), weighted r.m.s.d. (<TT><B>wrmsd</B></TT>)
or unweighted r.m.s.d. (<TT><B>unwrmsd</B></TT>). This is controlled by the
<TT><B>sort</B></TT> parameter of the <TT><B>output</B></TT> scope. Default:
input order (<TT><B>input</B></TT>).
</P>

<P><H5><U>Specific limitations and possible problems</U></H5></P>

<P><H5>Processing features</H5></P>
<UL>
<LI>Ensembler considers each chain individually and therefore it is not
possible to superpose assemblies. The rationale is that its primary purpose is
ensemble generation for molecular replacement and since intermolecular
interactions are weak, assemblies are unlikely to be preserved, and one would
obtain better models by an assembly of ensembles of monomers than the other way
round.</LI>
<LI>Very short residue segments (shorter than 3 consecutive residues) cannot be
reliably aligned to the sequence, and these will be discarded from the
superposition.</LI>
</UL>

<P><H5>Warning and error messages</H5></P>
<UL>
<LI><TT><B>No alignments given</B></TT>: no alignments were specified and a
user-supplied alignment based mapping method was requested.</LI>
<LI><TT><B>Unsuitable alignment set: different master sequences</B></TT>: this
indicates that the series of input alignments cannot be assembled because of a
different master sequence.</LI>
<LI><TT><B>Several alignment files specified; using first one only</B></TT>:
this warning indicates that several alignment files were specified, but
<TT><B>multiple_alignment</B></TT> was selected as mapping mode, which cannot
assemble alignments.</LI>
<LI><TT><B>No matching alignment for chain...</B></TT>: no alignment sequence
matches <B>chain ...</B> and a user-supplied alignment based mapping method was
requested.</LI>
<LI><TT><B>SSM error:...</B></TT>: an error occurred during SSM
superposition.</LI>
<LI><TT><B>Less than 2 chains for superposition</B></TT>: superposition cannot
proceed because there are less than 2 chains found.<LI>
<LI><TT><B>Less than 3 sites for superposition</B></TT>: superposition cannot
proceed because there are less than 3 sites available (this is checked after
discarding gaps). If this error occurs, discarding the chain with the lowest
overlap (printed just before the error is raised) may allow one to proceed.</LI>
<LI><TT><B>Excessive weight shift, damping weight change</B></TT>: this warning
is emitted if weights need to be damped, because all weights are zero.</LI>
<LI><TT><B>Weight damping recovery exhausted</B></TT>: this error is raised if
even after successive rounds of re-weighting, all weights are still zero. This
either indicates incorrect alignment of the chains or too tight expected
error.</LI>
</UL>

<P><H5><U>Literature</U></H5></P>
<UL>
<LI>
    <B>A note on the rotational superposition problem.</B>
    R. Diamond
    <I>Acta Cryst.</I> <B>A44</B>, 211-216 (1988)
</LI>
<LI>
    <B>On the multiple simultaneous superposition of molecular structures by
    rigid body transformations.</B>
    R. Diamond
    <I>Protein Science</I> <B>1</B>, 1279-1287 (1992)
</LI>
<LI>
    <B>Defining and computing optimum RMSD for gapped and weighted
    multiple-structure alignment.</B>
    X. Wang and J. Snoeyink
    <I>EEE/ACM Transactions on Computational Biology and Bioinformatics</I>
    <B>5</B>, 525-533 (2008)
</LI>
</UL>

<P><H5><U>Additional information</U></H5></P>

<!--REMARK PHENIX BODY END-->
