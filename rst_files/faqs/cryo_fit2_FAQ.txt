==============================================
Cryo_fit2 FAQ
==============================================

.. contents::



After cryo_fit2, secondary structures of my input molecule tend to be broken.
------------------------------------------------------------------------------------------
- Doo Nam observed that when he provided a little less ideal helix (i.g. one H-bond length within helix is rather long), then cryo_fit2 tends to "loosen/unwind" that "kink" area.

- When he provided a longer `distance_cut_n_o <https://www.phenix-online.org/documentation/reference/model_idealization.html>`__ (i.g. 4~4.5), the geometry of helix was kept well (it maintained the helical kink spot).

 - For example, phenix.cryo_fit2 <user.pdb> <user.map> resolution=<reso> secondary_structure.protein.distance_cut_n_o=4.5

- Alternatively, a user can specify a lower map_weight_multiply.

 - For example, phenix.cryo_fit2 <user.pdb> <user.map> resolution=<x> map_weight_multiply=0.2.

- Alternatively, a user can use `phenix.model_idealization <https://www.phenix-online.org/documentation/reference/model_idealization.html>`__ after cryo_fit2 to restore broken secondary structures (if any).




Cryo_fit2 cannot fit my molecule to a map.
--------------------------------------------------------------
- Sometimes, Doo Nam cannot fit his challenging protein molecule (that requires a significant conformational change to be fitted) to a map.
 
 - When he enforced stronger map_weight_multiply, he could fit the molecule.

  - For example, phenix.cryo_fit2 <user.pdb> <user.map> resolution=<x> map_weight_multiply=15
 
  - At this high map_weight_multiply, the secondary structure (helix) looked broken right after cryo_fit2 running.

  - However, `phenix.model_idealization <https://www.phenix-online.org/documentation/reference/model_idealization.html>`__ which is followed by `phenix.real_space_refine <https://www.phenix-online.org/documentation/reference/real_space_refine.html>`__ perfectly restored ideal secondary structures and fitted very well.

- Sometimes, Doo Nam cannot fit his challenging molecule (half of the molecule is already fitted, the other half is not fitted) to a map.

 - It appears as if the molecule needs to pass through a local minimum energetically for a perferct fit.

 - Therefore, he solved this problem by running `phenix.dock_in_map <https://www.phenix-online.org/documentation/reference/dock_in_map.html>`__ which is followed by cryo_fit2.



How can I provide gaussian filtered maps?
----------------------------------------------------
- Many people in flexible fitting field know that often providing gaussian filtered maps results in better fitting.

 - For example, flexibly fit with a 4 angstrom filtered map. 
 
 - Then with the resultant atomic model and a 2 angstrom filtered map, do flexible fitting. 

 - Then with the resultant atomic model and a non-filtered map, do final flexible fitting.

- UCSF Chimera can generate these filtered maps.

 - Tools -> Volume Data -> Volume Viewer -> Tools -> Volume Filter -> (Set Width, e.g. 4,2) -> Filter

 - File -> Save map as -> (name a filtered map) -> Save



How to improve initial cc?
---------------------------------------
- `phenix.dock_in_map <https://www.phenix-online.org/documentation/reference/dock_in_map.html>`__, UCSF Chimera's 'Fit in Map (Tools -> Volume Data -> Fit in Map)', UCSF Chimera's manual fitting (using a mouse) often improve initial cross-correlation (cc) between map and model. UCSF ChimeraX's isolde may improve initial cc as well.



How to maximize cc?
----------------------------------------------------------------------------------------
- Generally, cryo_fit2 which is followed by phenix.real_space_refine tends to maximize cc.

- If there is a room/chance to idealize secondary structure further even after cryo_fit2, then cryo_fit2 + `phenix.model_idealization <https://www.phenix-online.org/documentation/reference/model_idealization.html>`__ + `phenix.real_space_refine <https://www.phenix-online.org/documentation/reference/real_space_refine.html>`__ combination resulted in the maximum cc.

- When the fitting needs to pass through a local minimum energetically for a perferct fit (half of the molecule is already fitted, the other half is not fitted), running `phenix.dock_in_map <https://www.phenix-online.org/documentation/reference/dock_in_map.html>`__ or UCSF Chimera's 'fit in map' before cryo_fit2 is recommended.

- When the fitting protein molecule to a map requires a significant conformational change, enforcing stronger map_weight_multiply tends to fit better (obviously).

  - For example, phenix.cryo_fit2 <user.pdb> <user.map> resolution=<x> map_weight_multiply=15

  - At this high map_weight_multiply, the secondary structures may be broken (slightly or seriously) right after cryo_fit2 running.

  - However, `phenix.model_idealization <https://www.phenix-online.org/documentation/reference/model_idealization.html>`__ which is followed by `phenix.real_space_refine <https://www.phenix-online.org/documentation/reference/real_space_refine.html>`__ perfectly restored ideal secondary structures and fitted very well.



I have a little less ideal helix to fit.
----------------------------------------------------
- Doo Nam observed that when he provided a little less ideal helix (i.g. one H-bond length within helix is rather long), then cryo_fit2 tends to "loosen/unwind" that "kink" area.

- When he provided a longer distance_cut_n_o (i.g. 4~4.5), the geometry of helix was kept well (it maintained the helical kink spot).

 - For example, phenix.cryo_fit2 <user.pdb> <user.map> resolution=<reso> secondary_structure.protein.distance_cut_n_o=4.5

  - For more detail, see `secondary_structure_restraints <https://www.phenix-online.org/documentation/reference/secondary_structure_restraints.html>`__


I have a SAXS based cryo-EM map.
------------------------------------------
- Please use map_weight < 0.2 for SAXS (small angle x-ray scattering) data based cryo-EM map

  - A user can transform saxs data into cryo-EM map (mrc/sit) by
    `Situs SAXS <http://situs.biomachina.org/tutorial_saxs.html>`_

  - However, this is nothing but central points by SAXS, although
    UCSF Chimera will visualize this "cryo-EM" map (mrc/sit) as regular cryo-EM map


I have a very small molecule to fit.
----------------------------------------------------
- When Doo Nam tried to fit a very small molecule (i.e. 11 residues long), both real_space_refine and cryo_fit2 couldn't fit to cryo-EM map.
- The reason could be that effect of sidechains is too large (in this kind of small molecule), so that global fitting is hindered.
- Doo Nam confirmed that `dock_in_map <https://www.phenix-online.org/documentation/reference/dock_in_map.html>`__ fits globally much better for this case.


Is there a command line option for cryo_fit2 processing on multiple cores?
--------------------------------------------------------------------------------
- (Please be advised that using multiple cores for cryo_fit2 is only useful when explore=True)

- Like other PHENIX applications, specify nproc.

 - For example, phenix.cryo_fit2 nproc=40 model.pdb model.map resolution=3

- If nproc is not specified, cryo_fit2 will use 'available number of cores'/3



My input (before cryo_fit2) and output (after cryo_fit2) pdb files have different molecule sizes
-----------------------------------------------------------------------------------------------------
Although pdb text files show similar SCALES, input (before cryo_fit2)
and output (after cryo_fit2) pdb files may show different molecule
sizes in Pymol when Doo Nam used map that was made from phenix.map_box

Troubleshooting is ongoing. 

In the meantime, please use UCSF Chimera to visualize bio-molecules instead.



My model is shifted after `phenix.model_idealization <https://www.phenix-online.org/documentation/reference/model_idealization.html>`__.
------------------------------------------------------------------------------------------------------------------------------------------------------------------
- To prevent this, it is recommended to add map as well.

 - For example, phenix.model_idealization <user.pdb> <user.map that was used for cryo_fit2> (resolution information is not required)



"RuntimeError: cctbx Error: Miller index not in structure factor map"
--------------------------------------------------------------------------------------------
- When a user sees above message, consider to enter a correct resolution.

 - For example, Doo Nam uses either EMDB reported resolution or phenix.mtriage derived resolution to properly run cryo_fit2.



"Sorry: Crystal symmetry mismatch between different files."
--------------------------------------------------------------------------------------------
- Sometimes, Doo Nam observed,

 - "Sorry: Crystal symmetry mismatch between different files.

    (378, 378, 378, 90, 90, 90) P 1

    (103.95, 91.35, 89.25, 90, 90, 90) P 1"

 - The first line (378, ...) shows unit cell parameters from model.
 - The second line (103.95, ...) shows unit cell parameters from map.

- Solutions

 1. Just erase CRYST1 header information from an input pdb file. Then, provide that input file into cryo_fit2.

  - Cryo_fit2 will automatically extract CRYST1 header from map (both
    from original map and phenix.map_box derived map), and prepend (write at the first line) to the pdb file.

 2. (Alternatively) Just leave correct CRYST1 header only in an input pdb file.
 
  - For example, when a wrong CRYST1 header exists above a correct
    CRYST1 header, above error message appeared.


When cryo_fit2 is useful?
----------------------------------------------------------------------------------------
- To model dynamic conformational change, cryo_fit2 is useful.
- To simply fit to cryo-EM map, cryo_fit seems to be useful when initial cc_mask and cc_box < 0.6. When initial cc_mask and cc_box >= 0.6, `phenix.real_space_refine <https://www.phenix-online.org/documentation/reference/real_space_refine.html>`__ tends to do similar fitting with faster speed. 


What to do after cryo_fit2?
----------------------------------------------------------------------------------------
- If there is a room/chance to idealize secondary structure further even after cryo_fit2, then run `phenix.model_idealization <https://www.phenix-online.org/documentation/reference/model_idealization.html>`__ which is followed by `phenix.real_space_refine <https://www.phenix-online.org/documentation/reference/real_space_refine.html>`__.

- Otherwise, just run `phenix.real_space_refine <https://www.phenix-online.org/documentation/reference/real_space_refine.html>`__ to improve overall geometry (such as rotamers).
