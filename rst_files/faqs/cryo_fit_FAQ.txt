==============================================
Cryo_fit1 FAQ
==============================================

.. contents::



How long does it take to run cryo_fit?
---------------------------------------
.. image:: ../images/cryo_fit_FAQ_how_long1.png
.. image:: ../images/cryo_fit_FAQ_how_long2.png



How to enlarge map box size?
--------------------------------------------------------
- Doo Nam uses `relion_image_handler <http://molecularart.dk/2015/11/cryo-em-how-to-change-box-size-and-pixel-size/>`__ to change map box size.
- For example, relion_image_handler --i user.mrc --new_box 370 --o user_box_size_370.mrc


How to generate and record movie?
---------------------------------------
- `Generate_record_movie_by_cryo_fit1 <../tutorials/cryo_fit_movie.html>`__


How to improve initial cc?
---------------------------------------
- `dock_in_map <https://www.phenix-online.org/documentation/reference/dock_in_map.html>`__ or UCSF Chimera's 'fit in map' or UCSF ChimeraX's isolde may improve initial cc.


I can't run phenix.superpose_pdbs with cryo_fitted pdb file
-----------------------------------------------------------------
phenix.superpose_pdbs can superimpose only between pdb files that have equally/similarly aligned nucleic names.
This applies to all pdb input files (not only cryo_fitted files).
Consider to align both input files by "python <User Phenix Path>/modules/cryo_fit/steps/9_after_cryo_fit/align_nucleic_acid_name_into_middle/align_nucleic_acid_name_into_middle.py"


I observe cc values keep decreasing (or do not increase that much) during step 8
------------------------------------------------------------------------------------------
- Initial few steps of cryo_fit in step 8 may decrease cc values temporarily as an initial perturbation.
- However, if it keeps decreasing continuously (or do not increase that much), it may  indicate two possible reasons.

  1. If a user input pdb file has reasonable structural geometry. Then, probablay, the initial correlation between user input pdb file and cryo-EM map is already high enough. Since cryo_fit considers physically reasonable energy conformation based on MD forcefield (amber03.ff), if the initial cc is already high, cryo_fit may decrease cc eventually. If a user deems his/her input pdb file has a reasonable geometry yet cryo_fit can't find better(higher) cc, then cryo_fit may not be necessary. Just run phenix.real_space_refine only and deposit. Doo Nam recommends to argue/claim in a paper like "our fit is so high, even cryo_fit didn't find higher level of fit", because cryo_fit automatically increases emweight_multiply_by if it doesn't find higher cc. Therefore, if cryo_fit can't find higher cc even with its higher emweight_multiply_by, it may mean that current fitting is pretty good.

 2. If a user input pdb file has unreasonable structural geometry. Although the fit between atomic model and map looks good, it is a fictitious fitting without considering ideal geometry. Run cryo_fit to find decent fit to the cryo-EM map along maintaining reasonable structural geometry.

- There are four possible solutions

 1. Providing higher (better) resolution map tends to help this problem.
 2. Enforcing stronger map weight tends to help this problem.
 3. If cryo_fit is provided a giant cryoem map with a tiny atomic model.
        Then, the cryo_fit calculates the gradient of CC because of the large empty space not filled. The constraint forces for the model are not helping as they are very small.
	
  3-1. Re-run cryo_fit with an atomic model that fits the majority of the map.
          Fit multiple atomic models into a symmetric map or sequential fitting into a non-symmetric map.  Watch https://www.youtube.com/watch?v=6VGYo1pRRZ8&t=0s&list=PLVetO1F9gm_oa--j37yrjzJ4yVJYzPVN5&index=12
	 
  3-2. Re-run cryo_fit with only relevant map region. A user can extract relevant map region by phenix.map_box (preferred) or phenix.map_to_model
  
 4. If the initial model is not properly aligned to a map, fit using UCSF Chimera -> Tools -> Volume Data -> Fit in Map



I see "Fatal error: A charge group moved too far between two domain decomposition steps. This usually means that your system is not well equilibrated" at my 8_cryo_fit step.
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
- Using macOS 10.13.6 helped rather than using Ubuntu 16.04. Maybe macOS has better numerical stability.
- One gromacs expert suggested to try smaller time_step_for_cryo_fit. 
- However for Doo Nam, simply using macOS solved the problem.
- Less likely, but still a possible reason is that the map weight is too high. Therefore, lowering emweight_multiply_by may help.


I see "Fatal error: Incomplete ring in HIS50" at my 8_cryo_fit step
------------------------------------------------------------------------
- Doo Nam observed this error when he tried to run cryo_fit with 3jch.pdb that has incomplete Histidine ring atoms.
- He solved with UCSF Chimera

 1. Open pdb file
 2. [menu]
 3. Select -> Residue -> HIS
 4. Tools -> Structure Editing -> Rotamers -> OK
 5. (select the most probable rotamer each)
 6. File -> Save PDB

- Pymol and Swisspdb viewer have similar residue fixing functions
- Alternatively, a user may identify residues manually by running <phenix-xxxx>/modules/cryo_fit/steps/0_prepare_cryo_fit/count_number_of_atoms_in_each_residue/



I see "Fatal error: Number of grid cells is zero. Probably the system and box collapsed." at my 8_cryo_fit step.
-------------------------------------------------------------------------------------------------------------------------------
- step_8 may be full of stepxb_nx.pdb.
- Most likely, this means that initial cc is too low for MD simulation.
- When Doo Nam ran real_space_refine first, then run real_space_refined atomic model in cryo_fit, it was solved.
- Alternatively, improve initial cc by fitting initial atomic model into a map (see "How to improve initial cc?" in this FAQ)
- Less likely, but still a possible case is when the map weight is too high, lowering emweight_multiply_by may help.



I see "pdb file cleaning is not done" at my step 1 (Make gro and topology file by regular gromacs)
--------------------------------------------------------------------------------------------------------------
"I edited out lipids, HEM and other hetero atoms and I verified that they are all gone. However, still my pdb file is not clean enough for gromacs_cryo_fit".

- If your lipids, HEM and other hetero atoms are not necessary for now, you may take out as you did. You may add those atoms after flexible fit (cryo_fit). Please send Doo Nam (doonam@lanl.gov) your pdb input file only (no map). He will take a look. gromacs_cryo_fit uses amber03 which may not have forcefield parameters for your less-usual atoms/residues.

- If your lipids, HEM and other hetero atoms are necessary for now and your target is protein, Doo Nam would recommend `cryo_fit2 <https://phenix-online.org/documentation/reference/cryo_fit2.html>`__ since it supports phenix.eLBOW derived ligand parameters.



I see "state.cpt not found, step_8 may be full of stepxb_nx.pdb" at my 8_cryo_fit step
-------------------------------------------------------------------------------------------------------------------------------
- Literally, step_8 may be full of stepxb_nx.pdb.
- Most likely, this means that a cryo_fit input pdb file is not yet stable enough for for SENSITIVE gromacs MD simulation (step 8) even after cryo_fit's ample minimization step (e.g. step 4).
- When Doo Nam ran real_space_refine first, then run real_space_refined atomic model in cryo_fit, it was solved more than 2 cases.
- If initial cc is too low, improve initial cc by fitting initial atomic model into a map (see "How to improve initial cc?" in this FAQ)
- Less likely, but still a possible case is when the map weight is too high, lowering emweight_multiply_by may help.



I see "step 0 correlation coefficient: nan" at my 8_cryo_fit step.
-----------------------------------------------------------------------------------------------
- This often indicates that the initial atomic model is not placed into a cryo-EM map.
- Please improve initial cc by fitting initial atomic model into a map (see "How to improve initial cc?" in this FAQ)



I see "step 0 correlation coefficient: nan" and "Range checking error: Explanation: During neighbor searching, we assign each particle to a grid based on its coordinates. If your system contains collisions or parameter errors that give particles very high velocities you might end up with some coordinates being +-Infinity or NaN (not-a-number). Obviously, we cannot put these on a grid, so this is usually where we detect those errors. Make sure your system is properly energy-minimized and that the potential energy seems reasonable before trying again." at my 8_cryo_fit step.
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
- Based on Doo Nam's experiences, this error message may indicate between two cases/scenarios.
- (The 1st case) It means that atomic model is not stable enough. When Doo Nam ran phenix.real_space_refine and provided real_space_refined pdb file into cryo_fit, the problem was solved.
- (The 2nd case) It means that the map dimensions need to be larger. Therefore, check map size and solve a problem with VMD/EMAN2/relion like followings.
- Like other MD simulations, gromacs need enough map box size to cover the atomic model to run (ziggle and wiggle). Refer `Waters seems to be out of the box <http://www.cgmartini.nl/index.php/component/kunena/10-other/367-sa-error>`__
- For example, stuck-out red oxygen atoms outside the right edge of the box are the problem.
- .. image:: ../images/cryo_fit_FAQ_sticking_out.png
- In order to run any MD simulation (including cryo_fit), a box should be large enough like
- .. image:: ../images/cryo_fit_FAQ_not_stick_out.png
- Make map box size larger (see "How to enlarge map box size?" in this FAQ), and run cryo_fit again. You can check map box size by VMD. Alternatively, remove sticking out atoms if these are unnecessary, then run cryo_fit again.
- For protein modeling, I would use `cryo_fit2  <https://github.com/cryoFIT/cryo_fit2>`__ which is not limited by box size requirement. Most of the time, it better fits than cryo_fit1 in terms of fitting and geometry preservation anyway.



I see "The initial cell size (xxx) is smaller than the cell size limit (xxx), change options -dd, -rdd or -rcon, see the log file for details" at my 8_cryo_fit step
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
- Doo Nam observed this error when he unspecified/deleted a certain region of a molecule in input pdb file. Even when vmd assisted map box/cell dimension is larger than initial molecule space, this error appeared.



I see "User's provided atomic model had 0.0 cc" in my cryo_fit.overall_log.
---------------------------------------------------------------------------------------------------------------
- It means that literally user's provided atomic model has no correlation to map to start with. 
- See "How to improve initial cc?" in this FAQ, and provide initially aligned atomic model to cryo_fit.
