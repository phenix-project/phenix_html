Density modification of cryo EM maps with resolve_cryo_em
=========================================================

Author(s)
---------

-  resolve_cryo_em: Tom Terwilliger

Purpose
-------

The routine resolve_cryo_em is a tool for carrying out density modification
of cryo-EM maps

Usage
-----

Density modification with resolve_cryo_em can be carried out based on two 
half-maps, along with the FSC-based resolution and a sequence file specifying
the contents of the map.

Density modification can also be carried out by using the initial 
density-modified map as a basis for generating multiple models, then averaging
the model-based maps with the density-modified map to yield a model-based
density modified map.

How resolve_cryo_em works:
--------------------------

Density modification with resolve_cryo_em is based on two ideas.  
One is that the errors in Fourier coefficients representing a cryo-EM map are
(to some extent) uncorrelated. This means that one Fourier coefficient does
not know about the errors in another one. (Note that this is not including
errors that are correlated simply because the molecule is small and is 
placed in a large map. Correlated errors in this context are those where one
Fourier coefficient has been adjusted to compensate for errors in another one.)

The other is that some features in a map are known in advance.  This could 
include features such as the flatness of the solvent region, distributions
of map values in the solvent and macromolecule region, similarities of
symmetry-related regions.

Then the way density modification works is that Fourier coefficients for 
the map are adjusted to agree both with the original map and with
the expected features. This improves the Fourier coefficients,
and the key result is that the map improves everywhere, not just where
the information about expected features was available.

Unique features of density modification for cryo-EM are that two half-maps with
independent errors are available in cryo-EM (allowing estimation of 
errors), and that the errors in Fourier coefficients are (more or less)
distributed as two-dimensional Gaussians (i.e both phase and amplitude
errors).  This leads to many differences in implementation density
modification in crystallography though core elements are identical.

Using resolve_cryo_em: 
----------------------

Normally you will access the functionality of resolve_cryo_em by running
the Phenix map_to_model tool in the Phenix GUI. 
However you can run it directly as well (there is no GUI for resolve_cryo_em).

Half-maps: Supply two unmasked half maps. They can be sharpened but it does
not make much of a difference.

Sequence file:  Supply a sequence file with the sequence of the molecule. Be
sure to put in all copies of the molecule (i.e. a 24-mer needs 24 chains).

Procedure used by resolve_cryo_em
---------------------------------

The inputs to resolve_cryo_em are:

::

  Two unmasked half-maps
  sequence file or molecular mass or solvent fraction

The procedure used by resolve_cryo_em has several steps:

::

  Boxing of maps:  If the supplied maps are much larger than the molecule,
  the maps are trimmed down to about 5 A bigger than the largest dimension
  of the molecule (estimated from a low-res mask and the molecular 
  volume based on sequence or as specified) in each direction.

  Resolution estimate and half-map sharpening of maps: The half-maps are
  compared as a function of resolution and the resolution (FSC=0.143)
  is estimated and the maps are sharpened based on the estimated map quality
  of the full (averaged) map.  A full map is calculated.

  Generation of map-value (density) histograms:  The full map is analyzed
  to identify the distribution of map values in the solvent and 
  macromolecule region.  These histograms are to be used in density 
  modification.

  Density modification of half-maps:  Each half map is density-modified
  using maximum-likelihood density modification. The histograms of map 
  values from the preceding step are used as targets indicating what the
  distribution should be in the density modified maps.

  Estimation of errors:  Fourier coefficients for the two starting 
  half-maps and the two density-modified maps are compared to give FSC
  values as a function of resolution.  These FSC values are used to estimate
  correlated and uncorrelated errors in the four maps and to identify
  optimal weighting between original and density-modified maps.

  Optional real-space and sigma weighting:  The smoothed local rms differences
  between original half maps and between density-modified half maps are 
  used (optionally) to identify location-specific weighting for the
  original and density-modified maps.  The variance of Fourier coefficients
  among the four maps are used (optionally) to weight individual final
  Fourier coefficients.

  Optional spectral scaling and local sharpening.  The final
  map is optionally scaled with a resolution-dependent scale factor 
  representing the radial part of a typical Fourier transform of a 
  macromolecule.  The final map is optionally locally resolution-filtered
  (local sharpening).  The final map is also optionally blurred slightly
  with a blurring dependent on the overall resolution of the map.

Procedure used by resolve_cryo_em for density modification with model-building
------------------------------------------------------------------------------

Density modification with model-building adds additional cycles to the
density modification procedure in which multiple models are built using
map_to_model and the averaged density and uncertainty in the average density
is used to combine the model density with the initial density-modified map.

The procedure includes:

::

  Create initial density-modified half-maps and full map

  Create N (typically 16) variants of the full map by changing the resolution
  cutoff, spectral_scaling, and blurring of the map.

  Build a model into each modified full map
 
  Refine some of the models against half-map 1 and some against half-map 2

  Create one composite model based on all models

  Create model density for each half-map based on the models refined againt
  that map.  This model density will have a mean value and variance for each
  point in the map near to at least 3 models.

  Create composite density for each half-maps by combining the model density 
  with the density-modified half-map, weighting the model density according to 
  its consistency among models.

  Density-modify each composite half-map, and create a new set of density 
  modified half-maps and full map, as in the procedure for standard 
  density modification.

  Sharpen the resulting maps using model-based sharpening with the composite
  model.


Examples
--------

Standard run of resolve_cryo_em:
--------------------------------

You can use resolve_cryo_em to density-modify a cryo-EM map: 

::

   phenix.resolve_cryo_em half_map_A.mrc half_map_B.mrc seq_file=seq.dat

Possible Problems
-----------------

If the half-maps have been masked the procedure may not work well.

If the solvent noise is very non-uniform the procedure may work poorly.
By default a rectangular solid region enclosing the molecule is cut out 
and used in density modification.  You can supply a boxed map and 
set the keyword box_before_analysis=False to avoid this.

If the maps have very prominent density away from the macromolecule this
may interfere with density modification.

If there is non-macromolecule but real density in the maps this 
may interfere with density modification (for example, lipid density).

Specific limitations and problems:
----------------------------------

Density modification introduces some correlations between half-maps
due to solvent flattening. This can have a small effect on the resolution
estimates obtained with half-map FSC.  The resolution estimates provided
by the program are corrected for this effect.

If you use the real_space_weighting or sigma_weighting or 
sharpening_type=local_final_half_map options there may be some 
extra correlations between half-maps introduced.  Calculating resolution
using FSC between these density-modified maps can lead to overstating the
resolution. The resolution estimates provided by the program are before 
applying these weighting schemes (unless you specify local_methods_final_cycle = False and run multiple cycles) so they are not normally affected by this.

The density modification procedure works best in the resolution range of about 4.5 A or better.

Model-based density modification necessarily biases the map towards the models
that are built.  By building multiple models, the effect of this bias is
reduced but not eliminated.  For example if the starting map has an error that
causes models to be built with a side chain the wrong place, the new model-
based density will show even more density in that location.  It is essential
that the original or non-model-based maps be consulted to evaluate any specific
density in the map.

Literature
----------

{{citation:resolve_cryo_em}}

Additional information
----------------------


List of all available keywords
------------------------------

{{phil:phenix.programs.resolve_cryo_em}}

