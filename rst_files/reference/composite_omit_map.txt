===============================
Generating a composite omit map
===============================

.. contents::

Overview
--------

A composite omit map is an omit map covering the entire contents of the
unit cell, generated by computing a number of omit maps covering specific
regions, and combining the areas around the omitted regions.  This allows
a relatively bias-free map to be calculated for the structure without
severely compromising phase quality.  Because this is significantly slower
than computing a simple omit map, it is not recommended if you are only
interested in a specific ligand or problematic region of the structure.
However, because the procedure is inherently parallel, it may be spread out
over multiple processors or cluster nodes to limit the runtime.

The program ``phenix.composite_omit_map`` is used to generate these maps;
internally, it is essentially no more than a wrapper for `phenix.refine
<refinement.html>`_ and
the underlying map-calculation code.  It may be run in three different modes:

  - **with simulated annealing**, which aggressively removes residual bias
    in the partial models (but increases runtime).
  - **with minimization only**, without annealing
  - **without refinement**, which leaves the partial models alone, but performs
    an iterative procedure to quickly remove phase bias.

The final option is the default, since it is very fast but still effective.
For best results we recommend running with simulated annealing, although this
may be more problematic for especially poor and/or low-resolution structures.

Running the program
-------------------

Execution of the program is very similar to running phenix.refine::

  % phenix.composite_omit_map model.pdb data.mtz ligands.cif nproc=64


The requirements for input files and formats are the same.  Because the
program is intended to be as automatic as possible, only a limited
subset of refinement parameters are exposed to the user.  Refinement may be
disabled by adding ``refine=False`` to the command line; annealing is switched
on by adding ``anneal=True``.  Like phenix.refine, experimental phases
(Hendrickson-Lattman coefficients) will be used automatically if present, and
you may specify a twin law if necessary.

You may request any supported combination of maps using the same map type
strings as elsewhere in Phenix, for instance **2mFo-DFc**, **anomalous**,
**3mFo-2DFc**, and so on.  The default map type is 2mFo-DFc, but the
``map_type`` keyword may specify one or more alternate maps.  You may
also change the choice of whether to fill in missing observations with F(calc)
(off by default), or whether to exclude reflections flagged for calculating
R-free (on by default).  NCS averaging is also available as an option.

If simulated annealing is to be run, you may specify the dynamics type
(``annealing_type`` keyword, either "cartesian" or "torsion") and the
starting temperature (``annealing_temperature``, which defaults to 5000K
for Cartesian and 2500K for torsion; lower will run more quickly).  The
atoms left out of structure factor calculation will by default be restrained
to their starting positions to prevent the other atoms from filling in the
missing scattering.  Note that the default behavior allows the bulk solvent
mask to extend into the omitted region; this may be turned off by adding
the argument ``exclude_bulk_solvent=True``, but it is unclear what the best
practice is.

The program will parallelize over multi-core systems or managed clusters
(including Sun Grid Engine, PBS, and LSF queuing systems) if the ``nproc``
keyword is given.  Use the ``technology`` keyword to specify the system
type.  The default behavior is to omit up to approximately 5% of the structure
at a time (controlled by the ``fraction_omit`` keyword), but in practice
because of the way the structure is divided there will be significantly
more than 20 omit regions for the typical macromolecular structure.  If you
are unsure how many processes to use, specify ``nproc=Auto``.

Output consists of a single MTZ file, named ``composite_omit_map.mtz`` by
default; you may specify a preferred file name using the command line keyword
``output.file_name``.  This will contain amplitudes and phases for each
map type.  For 2mFo-DFc maps, the MTZ column labels will be interpretable
using the auto-open function in Coot; all other map types require you to
load them manually.

Singe-omit mode
---------------

The program can also be used to generate a simple omit map for a single
region; the iterative de-bias procedure is not available in this mode, but you
can perform refinement and/or simulated annealing.  This is essentially
equivalent to setting up a phenix.refine run manually, but with a simplified
interface.

Other options
-------------

There are several other programs in Phenix with similar features:

  - `AutoBuild <autobuild.html>`_ has an older implementation of this method.
    A more powerful approach is to generate an "iterative-build" omit map
    (Terwilliger et al. 2008), which rebuilds the structure instead of
    annealing.
  - `phenix.refine <refinement.html>`_ can be used to manually generate omit
    maps for a smaller selection of the model by specifying the
    ``omit_selection`` keyword.  The single-omit mode of the composite omit
    map program is equivalent to this.
  - `phenix.maps <maps.html>`_ can generate simple omit maps without refinement.

References
----------

{{citation:anneal_omit}}
{{citation:autobuild_omit}}
{{citation:phenix.refine}}

{{phil:phenix.command_line.composite_omit_map}}
